<!DOCTYPE html>
<html>
<head>
    <title>AI bots</title>
    <link href="../_shared/demo.css" rel="stylesheet" type="text/css">
    <script src="http://code.createjs.com/easeljs-0.7.0.min.js"></script>
    <script src="https://code.createjs.com/tweenjs-0.6.2.min.js"></script>
    <script>

        var $map;
        var stage;
        var pawns;
        var ball;
        var created = false;

        function init() {
            $map = document.getElementById('map');
            stage = new createjs.Stage($map);
            createjs.Ticker.setFPS(60);
            createjs.Ticker.addEventListener('tick', stage);

            connect();
        }

        function createMap(data) {
            console.log('createMap', data);

            // Create map

            addBall(data.ball);
            addPawns(data.pawns);
            created = true;
        }

        function addBall(data) {
            console.log('addBall', data);

            ball = new createjs.Shape();
            ball.graphics.beginFill('black').drawCircle(0, 0, 4);
            ball.x = data.position.y * 10 + $map.width / 2;
            ball.y = data.position.x * 10 + $map.height / 2;
            stage.addChild(ball);
        }

        function addPawns(data) {
            console.log('addPawns', data);

            pawns = [];
            for (var i = 0; i < data.length; i++) {
                var pawn = new createjs.Shape();
                var color = 'red';
                if (data[i].team == 1) {
                    color = 'blue';
                }
                pawn.graphics.beginFill(color).drawCircle(0, 0, 4);
                pawn.x = data[i].position.y * 10 + $map.width / 2;
                pawn.y = data[i].position.x * 10 + $map.height / 2;
                pawns.push(pawn)
                stage.addChild(pawn);
            }
        }

        function updatePositions(data) {
            // Ball
            updatePosition(ball, data.ball.position);

            // Pawns
            for (var i = 0; i < pawns.length; i++) {
                updatePosition(pawns[i], data.pawns[i].position);
            }
        }

        function updatePosition(object, position) {
            console.log('updatePosition', object, position);

            createjs.Tween.get(object, { loop: false })
                .to({
                    x: position.y * 10 + $map.width / 2,
                    y: position.x * 10 + $map.height / 2
                }, 1000, createjs.Ease.getPowOut(1)
            );
        }

        function connect() {
            console.log('connect');

            if (!('WebSocket' in window)) {
                alert('WebSocket is not supported by your Browser!');
                return;
            }

            var ws = new WebSocket('ws://localhost:3000/lobby');

            ws.onopen = function() {
                console.log('ws.onopen');

                ws.send(JSON.stringify({
                    role : 'spectator',
                    game_id : 55
                }));
            };

            ws.onmessage = function (evt) {
                console.log('ws.onmessage', evt);

                var data = JSON.parse(evt.data);

                if (!data) {
                    return false;
                }

                if (!created) {
                    createMap(data);
                }
                updatePositions(data);

                ws.send('Ping back');
                return false;
            };

            ws.onclose = function() {
                console.log('ws.onclose');
            };
        }

    </script>
</head>
<body onload="init();">
    <canvas id="map" width="800" height="500">
        alternate content
    </canvas>
</body>
</html>

